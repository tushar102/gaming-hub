(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{arraySwap:()=>h,getCurrentTime:()=>i,isFunction:()=>r,isTouchDevice:()=>n,random:()=>s,randomPositiveNegative:()=>a,requestAnimationFrameTool:()=>o});const i=()=>performance.now(),s=(t,e)=>Math.random()*(e-t)+t,a=()=>Math.random()<.5?-1:1,r=t=>"function"==typeof t,n=()=>"ontouchstart"in window||window.navigator.msMaxTouchPoints,o=(()=>{let t=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(e=>{window.setTimeout((()=>{const s=i();e(s);const a=i();t=1e3/60-(a-s)}),t)})})(),h=(t,e,i)=>{const s=t[i];t[i]=t[e],t[e]=s},c={linear:function(t,e,i,s){return i*t/s+e},easeIn:function(t,e,i,s){return i*(t/=s)*t+e},easeOut:function(t,e,i,s){return-i*(t/=s)*(t-2)+e},easeInOut:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e}},{requestAnimationFrameTool:d,isFunction:l,isTouchDevice:g}=e;class u{constructor(t={}){if(!document.createElement("canvas").getContext)return void window.alert("HTML5 Canvas is not supported in your browser.");const{canvasId:i,debug:s,width:a,height:r,highResolution:n,loadLimit:o,soundOn:h}=t;let c=a||window.innerWidth,d=r||window.innerHeight;this.canvas=document.getElementById(i),n&&(this.canvas.style.width=`${c}px`,this.canvas.style.height=`${d}px`,c*=2,d*=2),this.highResolution=n,this.canvas.width=c,this.canvas.height=d,this.width=this.canvas.width,this.height=this.canvas.height,this.calWidth=.5*this.width,this.calHeight=.5*this.height,this.debug=!!s,this.ctx=this.canvas.getContext("2d"),this.defaultLayer="default",this.layerArr=[this.defaultLayer],this.instancesObj={},this.instancesObj[this.defaultLayer]=[],this.instancesReactionArr=[],this.utils=e,this.customVariable={};const l=this;this.isTouchDevice=g(),this.debugArr=[],this.assetsObj={image:{},audio:{}},this.assetsCount={image:0,audio:0},this.assetsErrorQueue=[],this.assetsErrorCount=0,this.loadLimit=o||3,this.soundOn=!!h,this.fps=0,this.lastTime=0,this.lastPausedAt=0,this.pausedTime=0,this.paused=!1,this.timeMovement={},this.timeMovementStartArr=[],this.timeMovementFinishArr=[],this.keyUpListeners={},this.keyDownListeners={},this.keyPressListeners={},this.startAnimate=()=>{},this.paintUnderInstance=()=>{},this.paintAboveInstance=()=>{},this.endAnimate=()=>{},this.touchStartListener=()=>{},this.touchEndListener=()=>{},this.touchMoveListener=()=>{},document.addEventListener("keyup",(t=>{l.keyListener(t,"keyup")}),!1),document.addEventListener("keydown",(t=>{l.keyListener(t,"keydown")}),!1),document.addEventListener("keypress",(t=>{l.keyListener(t,"keypress")}),!1),this.isTouchDevice?(document.addEventListener("touchstart",(t=>{l.touchStartListener(t)}),!1),document.addEventListener("touchend",(t=>{l.touchEndListener(t)}),!1),document.addEventListener("touchmove",(t=>{l.touchMoveListener(t)}),!1)):(document.addEventListener("mousedown",(t=>{l.touchStartListener(t)}),!1),document.addEventListener("mouseup",(t=>{l.touchEndListener(t)}),!1),document.addEventListener("mousemove",(t=>{l.touchMoveListener(t)}),!1))}triggerReaction(t,e){let i=t,s=e;this.highResolution&&(i*=2,s*=2),this.instancesReactionArr.forEach((t=>{t.visible&&i>=t.x&&i<=t.x+t.width&&s>=t.y&&s<=t.y+t.height&&t.trigger(t,this)}))}addAudio(t,e,i=0){if(!this.soundOn)return;i||(this.assetsCount.audio+=1);const s=new window.Audio;s.src=e,this.assetsObj.audio[t]=s,s.addEventListener("error",(()=>{this.assetsErrorQueue.push({name:t,src:e,retry:i+1,type:"audio"})}),!1),s.load()}getAudio(t){return this.assetsObj.audio[t]}playAudio(t,e=!1){if(!this.soundOn)return;const i=this.getAudio(t);if(i){if(i.play(),!e)return;i.addEventListener("ended",(()=>{i.currentTime=0,i.play()}),!1)}}pauseAudio(t){const e=this.getAudio(t);e&&e.pause()}setVariable(t,e){this.customVariable[t]=e}getVariable(t,e=null){return this.customVariable[t]||(null!==e?(this.setVariable(t,e),e):null)}addImg(t,e,i=0){i||(this.assetsCount.image+=1);const s=new window.Image;s.src=e,s.onload=()=>{this.assetsObj.image[t]=s},s.onerror=()=>{this.assetsErrorQueue.push({name:t,src:e,retry:i+1,type:"image"})}}getImg(t){return this.assetsObj.image[t]}animate(t){const e=t-this.pausedTime,i=this;this.paused?setTimeout((()=>{this.animate.call(i,e)}),100):(this.tick(e),this.clean(),this.startAnimate(this,e),this.paintUnderInstance(this),this.updateInstances(e),this.paintInstances(),this.paintAboveInstance(),this.endAnimate(this,e),this.tickTimeMovement(),this.debug&&this.showFps(),this.debug&&this.drawDebug(),d((t=>{this.animate.call(i,t)})))}showFps(){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.font=(this.highResolution?32:16)+"px Arial",this.ctx.fillText(`FPS: ${this.fps.toFixed()}`,5,this.highResolution?40:20),this.ctx.restore()}debugLineX(t){this.debugArr.push({type:"lineX",y:t})}debugLineY(t){this.debugArr.push({type:"lineY",x:t})}debugDot(t,e){this.debugArr.push({type:"dot",x:t,y:e})}drawDebug(){this.debugArr.forEach((t=>{const{type:e,x:i,y:s}=t;switch(e){case"dot":this.drawDebugDot(i,s);break;case"lineX":this.drawDebugLine(null,s);break;case"lineY":this.drawDebugLine(i,null)}})),this.instancesReactionArr.forEach((t=>{t.visible&&(this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.rect(t.x,t.y,t.width,t.height),this.ctx.stroke())}))}drawDebugLine(t,e){let i=[0,e],s=[this.width,e];t&&(i=[t,0],s=[t,this.height]),this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.moveTo(...i),this.ctx.lineTo(...s),this.ctx.stroke(),this.ctx.restore()}drawDebugDot(t,e){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.beginPath(),this.ctx.arc(t,e,2,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(t,e,1,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.restore()}tick(t){this.updateFps(t),this.lastTime=t}updateFps(t){0===this.lastTime?this.fps=60:this.fps=1e3/(t-this.lastTime)}pixelsPerFrame(t){return t/this.fps}tickTimeMovement(){this.timeMovementStartArr.forEach((t=>{this.timeMovement[t].processing=!0})),this.timeMovementStartArr=[],this.timeMovementFinishArr.forEach((t=>{delete this.timeMovement[t]})),this.timeMovementFinishArr=[]}getTimeMovement(t,e,i,s={}){const{before:a,after:r}=s,n=c[s.easing||"linear"],o=s.name||"default",h=this.timeMovement[t];if(!h)return;h.processing||(this.timeMovementStartArr.push(t),h.store[o]=[],e.forEach((t=>{h.store[o].push({start:parseFloat(t[0]),end:parseFloat(t[1])})})),a&&a());const d=(t=!1)=>{const{duration:e}=h;let s=e;if(!t){const t=this.utils.getCurrentTime(),{startTime:e}=h;s=t-e}const a=h.store[o].map((t=>n(s,t.start,t.end-t.start,e)));i.apply(this,a)};this.checkTimeMovement(t)?d():(this.timeMovementFinishArr.push(t),d(!0),r&&r())}checkTimeMovement(t){const e=this.timeMovement[t]||{};return this.utils.getCurrentTime()<=e.endTime}setTimeMovement(t,e){const i=this.utils.getCurrentTime();this.timeMovement[t]={startTime:i,endTime:i+e,duration:e,store:{}}}clean(){this.ctx.clearRect(0,0,this.width,this.height),this.debugArr=[]}addLayer(t){this.layerArr.push(t),this.instancesObj[t]=[]}removeLayer(t){this.layerArr=this.layerArr.filter((e=>e!==t)),delete this.instancesObj[t]}swapLayer(t,e){this.utils.arraySwap(this.layerArr,t,e)}addInstance(t,e=this.defaultLayer){this.instancesObj[e].push(t),t.trigger&&this.instancesReactionArr.push(t)}getInstance(t,e=this.defaultLayer){return this.instancesObj[e].filter((e=>e.name===t))[0]}removeInstance(t,e=this.defaultLayer){const i=this.getInstance(t,e);i&&(this.instancesObj[e]=this.instancesObj[e].filter((e=>e.name!==t)),i.trigger&&(this.instancesReactionArr=this.instancesReactionArr.filter((e=>e.name!==t))))}updateInstances(t){this.layerArr.forEach((e=>{this.instancesObj[e].forEach((e=>{e.update&&e.update(this,t)}))}))}paintInstances(){this.layerArr.forEach((t=>{this.instancesObj[t].forEach((t=>{t.paint&&t.paint(this)}))}))}togglePaused(){const t=this.utils.getCurrentTime();this.paused=!this.paused,this.paused?this.lastPausedAt=t:this.pausedTime+=t-this.lastPausedAt}addKeyUpListener(t,e){this.keyUpListeners[t]=e}addKeyDownListener(t,e){this.keyDownListeners[t]=e}addKeyPressListener(t,e){this.keyPressListeners[t]=e}findKeyListener(t,e){return"keyup"===e?this.keyUpListeners[t]:"keydown"===e?this.keyDownListeners[t]:this.keyPressListeners[t]}keyListener(t,e){let i;switch(t.keyCode){case 13:i="enter";break;case 32:i="space";break;case 37:i="leftArrow";break;case 39:i="rightArrow";break;case 38:i="upArrow";break;case 40:i="downArrow";break;default:i=t.keyCode}const s=this.findKeyListener(i,e);s&&s()}load(t,e){const i=setInterval((()=>{const s=this.assetsCount.image+this.assetsCount.audio,a=Object.keys(this.assetsObj.image).length+Object.keys(this.assetsObj.audio).length;e&&l(e)&&e({success:a,failed:this.assetsErrorCount,total:s}),this.assetsErrorQueue.length>0&&(this.assetsErrorQueue.forEach((t=>{const{retry:e,name:i,src:s,type:a}=t;e>=this.loadLimit?this.assetsErrorCount+=1:"image"===a?this.addImg(i,s,e):this.addAudio(i,s,e)})),this.assetsErrorQueue=[]),a===s&&(t&&l(t)?t():this.init(),clearInterval(i))}),200)}init(){const t=this;d((e=>{this.animate.call(t,e)}))}}class m{constructor(t={}){const{name:e,painter:i,action:s,trigger:a}=t;this.name=e,this.x=0,this.y=0,this.width=0,this.height=0,this.ax=0,this.ay=0,this.vx=0,this.vy=0,this.visible=!0,this.painter=i||null,this.action=s||null,this.trigger=a||null,this.ready=!1}paint(t){null!==this.painter&&this.visible&&this.painter(this,t)}update(t,e){null!==this.action&&this.action(this,t,e)}updateWidth(t){this.width=t,this.calWidth=t/2}updateHeight(t){this.height=t,this.calHeight=t/2}}const b="GAME_START_NOW",y="GAME_USER_OPTION",p="HARD_MODE",w="SUCCESS_COUNT",x="FAILED_COUNT",v="PERFECT_COUNT",f="GAME_SCORE",T="HOOK_NORMAL",k="BACKGROUND_IMG_OFFSET_HEIGHT",A="LINE_INITIAL_OFFSET",I="BACKGROUND_LINEAR_GRADIENT_OFFSET_HEIGHT",V="BLOCK_COUNT",O="BLOCK_WIDTH",M="BLOCK_HEIGHT",L="CLOUD_SIZE",E="ROPE_HEIGHT",F="FLIGHT_COUNT",P="FLIGHT_LAYER",_="ROTATE_RIGHT",S="ROTATE_LEFT",R="SWING",N="BEFORE_DROP",C="DROP",D="LAND",W="OUT",H="INITIAL_ANGLE",G="BG_INIT_MOVEMENT",j="HOOK_DOWN_MOVEMENT",U="HOOK_UP_MOVEMENT",X="LIGHTNING_MOVEMENT",$="TUTORIAL_MOVEMENT",K="MOVE_DOWN_MOVEMENT",B=t=>t.checkTimeMovement(K),Y=(t,e)=>{const i=e?e.pixelsPerFrame:t.pixelsPerFrame.bind(t),s=t.getVariable(w),a=2*t.getVariable(M);return i(s<=4?1.25*a:a)},q=(t,e)=>{const i=t.getVariable(w),s=t.getVariable(f),{hookSpeed:a}=t.getVariable(y);if(a)return a(i,s);let r;switch(!0){case i<1:r=0;break;case i<10:r=1;break;case i<20:r=.8;break;case i<30:r=.7;break;default:r=.74}return t.getVariable(p)&&(r=1.1),Math.sin(e/(200/r))},Q=(t,e)=>{const i=t.getVariable(w),s=t.getVariable(f),{landBlockSpeed:a}=t.getVariable(y);if(a)return a(i,s);const{width:r}=t;let n;switch(!0){case i<5:n=0;break;case i<13:n=.001;break;case i<23:n=.002;break;default:n=.003}return Math.cos(e/200)*n*r},z=t=>t.checkTimeMovement(j)?"HOOK_DOWN":t.checkTimeMovement(U)?"HOOK_UP":T,Z=t=>{const{setGameFailed:e}=t.getVariable(y),i=t.getVariable(x)+1;t.setVariable(x,i),t.setVariable(v,0),e&&e(i),i>=3&&(t.pauseAudio("bgm"),t.playAudio("game-over"),t.setVariable(b,!1))},J=(t,e)=>{const{setGameScore:i,successScore:s,perfectScore:a}=t.getVariable(y),r=t.getVariable(v,0),n=e?r+1:0,o=t.getVariable(f)+(s||25)+(a||25)*n;t.setVariable(f,o),t.setVariable(v,n),i&&i(o)},tt=(t,e)=>{const{string:i,size:s,x:a,y:r,textAlign:n}=e,{ctx:o}=t,h=s,c=.1*h;o.save(),o.beginPath();const d=o.createLinearGradient(0,0,0,r);d.addColorStop(0,"#FAD961"),d.addColorStop(1,"#F76B1C"),o.fillStyle=d,o.lineWidth=c,o.strokeStyle="#FFF",o.textAlign=n||"center",o.font=`${h}px wenxue`,o.strokeText(i,a,r),o.fillText(i,a,r),o.restore()},et=(t,e,i)=>{const s=e+1>=t.length?t.length-1:e,a=t[s],r=t[s+1>=t.length-1?s:s+1],n=t=>{const e=a[t],s=r[t];return Math.round(e+(s-e)*i)};return`rgb(${n(0)}, ${n(1)}, ${n(2)})`},it=t=>{(t=>{const e=t.ctx.createLinearGradient(0,0,0,t.height),i=[[200,255,150],[105,230,240],[90,190,240],[85,100,190],[55,20,35],[75,25,35],[25,0,10]],s=t.getVariable(I,0);B(t)&&t.setVariable(I,s+1.5*Y(t));const a=parseInt(s/t.height,10),r=s%t.height/t.height,n=et(i,a,r),o=et(i,a+1,r);e.addColorStop(0,o),e.addColorStop(1,n),t.ctx.fillStyle=e,t.ctx.beginPath(),t.ctx.rect(0,0,t.width,t.height),t.ctx.fill();const h=()=>{t.ctx.fillStyle="rgba(255, 255, 255, 0.7)",t.ctx.fillRect(0,0,t.width,t.height)};t.getTimeMovement(X,[],(()=>{}),{before:h,after:h})})(t),(t=>{const e=t.getImg("background"),i=e.width,s=e.height*t.width/i;let a=t.getVariable(k,t.height-s);a>t.height||(t.getTimeMovement(K,[[a,a+Y(t,{pixelsPerFrame:t=>t/2})]],(t=>{a=t}),{name:"background"}),t.getTimeMovement(G,[[a,a+s/4]],(t=>{a=t})),t.setVariable(k,a),t.setVariable(A,t.height-.394*s),t.ctx.drawImage(e,0,a,t.width,s))})(t)},st=(t,e,i)=>{const s=t;s.ready||(s.y=e.getVariable(A),s.ready=!0,s.collisionX=e.width-e.getVariable(O)),e.getTimeMovement(K,[[t.y,t.y+Y(e,{pixelsPerFrame:t=>t/2})]],(e=>{t.y=e}),{name:"line"});const a=Q(e,i);t.x+=a,t.collisionX+=a},at=(t,e)=>{const{ctx:i,debug:s}=e;s&&(i.save(),i.beginPath(),i.strokeStyle="red",i.moveTo(t.x,t.y),i.lineTo(t.collisionX,t.y),i.lineWidth=1,i.stroke(),i.restore())},rt=t=>{const{count:e}=t;var i;t.imgName=(i=e>6?["c4","c5","c6","c7","c8"]:["c1","c2","c3"])[Math.floor(Math.random()*i.length)]},nt=(t,e)=>{if(!t.ready){t.ready=!0,rt(t),t.width=e.getVariable(L),t.height=e.getVariable(L);const i=e.width,s=e.height,a=[{x:.1*i,y:.66*-s},{x:.65*i,y:.33*-s},{x:.1*i,y:0},{x:.65*i,y:.33*s}][t.index-1];t.x=e.utils.random(a.x,1.2*a.x),t.originX=t.x,t.ax=e.pixelsPerFrame(t.width*e.utils.random(.05,.08)*e.utils.randomPositiveNegative()),t.y=e.utils.random(a.y,1.2*a.y)}t.x+=t.ax,(t.x>=t.originX+t.width||t.x<=t.originX-t.width)&&(t.ax*=-1),B(e)&&(t.y+=1.2*Y(e)),t.y>=e.height&&(t.y=.66*-e.height,t.count+=4,rt(t))},ot=(t,e)=>{const{ctx:i}=e,s=e.getImg(t.imgName);i.drawImage(s,t.x,t.y,t.width,t.height)},ht=(t,e,i)=>{const s=e.getVariable(E);t.ready||(t.x=e.width/2,t.y=-1.5*s,t.ready=!0),e.getTimeMovement(U,[[t.y,t.y-s]],(e=>{t.y=e}),{after:()=>{t.y=-1.5*s}}),e.getTimeMovement(j,[[t.y,t.y+s]],(e=>{t.y=e}),{name:"hook"});const a=e.getVariable(H);t.angle=a*q(e,i),t.weightX=t.x+Math.sin(t.angle)*s,t.weightY=t.y+Math.cos(t.angle)*s},ct=(t,e)=>{const{ctx:i}=e,s=e.getVariable(E),a=.1*s,r=e.getImg("hook");i.save(),i.translate(t.x,t.y),i.rotate(2*Math.PI-t.angle),i.translate(-t.x,-t.y),e.ctx.drawImage(r,t.x-a/2,t.y,a,s+5),i.restore()},dt=(t,e,i)=>{const{width:s,height:a}=e,{name:r}=t;if(!t.ready){t.ready=!0;const i=.2*s;t.updateWidth(i),t.height=.46*i,t.x=e.calWidth-t.calWidth,t.y=.45*a,"tutorial"!==r&&(t.y+=1.2*t.height)}"tutorial"!==r&&(t.y+=Math.cos(i/200)*t.height*.01)},lt=(t,e)=>{if(e.checkTimeMovement($))return;if(z(e)!==T)return;const{ctx:i}=e,{name:s}=t,a=e.getImg(s);i.drawImage(a,t.x,t.y,t.width,t.height)},gt=(t,e)=>{t.status===S?t.y-t.width>=e.height&&(t.visible=!1,t.status=W,Z(e)):t.y>=e.height&&(t.visible=!1,t.status=W,Z(e))},ut=(t,e,i)=>{const s=t,a=e.getVariable(E);if(!s.visible)return;s.ready||(s.ready=!0,s.status=R,t.updateWidth(e.getVariable(O)),t.updateHeight(e.getVariable(M)),t.x=e.width/2,t.y=-1.5*a);const r=e.getInstance("line");switch(s.status){case R:e.getTimeMovement(j,[[t.y,t.y+a]],(e=>{t.y=e}),{name:"block"}),((t,e,i)=>{const s=e.getVariable(E);if(t.status!==R)return;const a=t,r=e.getVariable(H);a.angle=r*q(e,i),a.weightX=a.x+Math.sin(a.angle)*s,a.weightY=a.y+Math.cos(a.angle)*s})(t,e,i);break;case N:s.x=t.weightX-t.calWidth,s.y=t.weightY+.3*t.height,s.rotate=0,s.ay=e.pixelsPerFrame(3e-4*e.height),s.startDropTime=i,s.status=C;break;case C:const n=i-s.startDropTime;s.startDropTime=i,s.vy+=s.ay*n,s.y+=s.vy*n+.5*s.ay*n**2;const o=((t,e)=>t.y+t.height>=e.y?t.x<e.x-t.calWidth||t.x>e.collisionX+t.calWidth?1:t.x<e.x?2:t.x>e.collisionX?3:t.x>e.x+.8*t.calWidth&&t.x<e.x+1.2*t.calWidth?5:4:0)(t,r),h=r.y-t.height,c=t=>{t.originOutwardAngle=Math.atan(t.height/t.outwardOffset),t.originHypotenuse=Math.sqrt(t.height**2+t.outwardOffset**2),e.playAudio("rotate")};switch(o){case 1:gt(t,e);break;case 2:s.status=S,t.y=h,t.outwardOffset=r.x+t.calWidth-t.x,c(t);break;case 3:s.status=_,t.y=h,t.outwardOffset=r.collisionX+t.calWidth-t.x,c(t);break;case 4:case 5:s.status=D;const i=e.getVariable(w);(t=>{const{setGameSuccess:e}=t.getVariable(y),i=t.getVariable(w)+1;t.setVariable(w,i),t.getVariable(p)&&t.setVariable(E,t.height*t.utils.random(.35,.55)),e&&e(i)})(e),e.setTimeMovement(K,500),10!==i&&15!==i||e.setTimeMovement(X,150),t.y=h,r.y=h,r.x=s.x-s.calWidth,r.collisionX=r.x+s.width;const a=.3*s.width;(s.x>e.width-2*a||s.x<-a)&&e.setVariable(p,!0),5===o?(t.perfect=!0,J(e,!0),e.playAudio("drop-perfect")):(J(e),e.playAudio("drop"))}break;case D:e.getTimeMovement(K,[[t.y,t.y+Y(e,{pixelsPerFrame:t=>t/2})]],(i=>{t.visible&&(t.y=i,t.y>e.height&&(t.visible=!1))}),{name:t.name}),t.x+=Q(e,i);break;case S:case _:const d=s.status===_,l=e.pixelsPerFrame(4*Math.PI),g=d?1:-1;if(d?t.rotate>1.3:t.rotate<-1.3)t.rotate+=l/8*g,t.y+=e.pixelsPerFrame(.7*e.height),t.x+=e.pixelsPerFrame(.3*e.width)*g;else{let e=(t.calWidth-t.outwardOffset)/t.calWidth;e=e>.5?e:.5,t.rotate+=l*e*g;const i=t.originOutwardAngle+t.rotate,s=d?r.collisionX+t.calWidth:r.x+t.calWidth,a=r.y;t.x=s-Math.cos(i)*t.originHypotenuse,t.y=a-Math.sin(i)*t.originHypotenuse}gt(t,e)}},mt=(t,e)=>{const{perfect:i}=t,s=e.getImg(i?"block-perfect":"block");e.ctx.drawImage(s,t.x,t.y,t.width,t.height)},bt=(t,e)=>{const{status:i}=t;switch(i){case R:((t,e)=>{const i=e.getImg("blockRope");e.ctx.drawImage(i,t.weightX-t.calWidth,t.weightY,t.width,1.3*t.height);const s=t.weightX-t.calWidth;e.debugLineY(s)})(t,e);break;case C:case D:mt(t,e);break;case S:case _:((t,e)=>{const{ctx:i}=e;i.save(),i.translate(t.x,t.y),i.rotate(t.rotate),i.translate(-t.x,-t.y),mt(t,e),i.restore()})(t,e)}},yt=(t,e)=>{const{visible:i,ready:s,type:a}=t;if(!i)return;const r=e.getVariable(L);if(!s){const i=((t,e)=>{const{width:i,height:s,utils:a}=t,{random:r}=a,n=t.getVariable(L);return{bottomToTop:{x:i*r(.3,.7),y:s,vx:0,vy:.7*t.pixelsPerFrame(s)*-1},leftToRight:{x:-1*n,y:s*r(.3,.6),vx:.4*t.pixelsPerFrame(i),vy:.1*t.pixelsPerFrame(s)*-1},rightToLeft:{x:i,y:s*r(.2,.5),vx:.4*t.pixelsPerFrame(i)*-1,vy:.1*t.pixelsPerFrame(s)},rightTopToLeft:{x:i,y:0,vx:.6*t.pixelsPerFrame(i)*-1,vy:.5*t.pixelsPerFrame(s)}}[e]})(e,a);t.ready=!0,t.width=r,t.height=r,t.x=i.x,t.y=i.y,t.vx=i.vx,t.vy=i.vy}t.x+=t.vx,t.y+=t.vy,(t.y+r<0||t.y>e.height||t.x+r<0||t.x>e.width)&&(t.visible=!1)},pt=(t,e)=>{const{ctx:i}=e,s=e.getImg(t.imgName);i.drawImage(s,t.x,t.y,t.width,t.height)},wt=(t,e,i)=>{if(t.getVariable(F)===e)return;const s=new m({name:`flight_${e}`,action:yt,painter:pt});s.imgName=`f${e}`,s.type=i,t.addInstance(s,P),t.setVariable(F,e)},xt=t=>{if(!t.getVariable(b))return;const e=t.getVariable(w,0),i=t.getVariable(x),s=t.getVariable(f,0),a=Number(e)>99?.1*t.width:0;tt(t,{string:"å±‚",size:.06*t.width,x:.24*t.width+a,y:.12*t.width,textAlign:"left"}),tt(t,{string:e,size:.17*t.width,x:.22*t.width+a,y:.2*t.width,textAlign:"right"});const r=t.getImg("score"),n=r.width,o=r.height,h=.35*t.width,c=o*h/n;t.ctx.drawImage(r,.61*t.width,.038*t.width,h,c),tt(t,{string:s,size:.06*t.width,x:.9*t.width,y:.11*t.width,textAlign:"right"});const{ctx:d}=t,l=t.getImg("heart"),g=l.width,u=l.height,m=.08*t.width,y=u*m/g;for(let e=1;e<=3;e+=1)d.save(),e<=i&&(d.globalAlpha=.2),d.drawImage(l,.66*t.width+(e-1)*m,.16*t.width,m,y),d.restore()},vt=t=>{if(!t.getVariable(b))return;const e=t.getInstance(`block_${t.getVariable(V)}`);if(!e||[D,W].indexOf(e.status)>-1){if(B(t)&&Y(t))return;if(t.checkTimeMovement(U))return;const e=(t=>{const e=t.getVariable(w),i=t.getVariable(f),{hookAngle:s}=t.getVariable(y);if(s)return s(e,i);if(t.getVariable(p))return 90;switch(!0){case e<10:return 30;case e<20:return 60;default:return 80}})(t),i=Math.PI*t.utils.random(e,e+5)*t.utils.randomPositiveNegative()/180;t.setVariable(V,t.getVariable(V)+1),t.setVariable(H,i),t.setTimeMovement(j,500);const s=new m({name:`block_${t.getVariable(V)}`,action:ut,painter:bt});t.addInstance(s)}switch(Number(t.getVariable(w,0))){case 2:wt(t,1,"leftToRight");break;case 6:wt(t,2,"rightToLeft");break;case 8:wt(t,3,"leftToRight");break;case 14:wt(t,4,"bottomToTop");break;case 18:wt(t,5,"bottomToTop");break;case 22:wt(t,6,"bottomToTop");break;case 25:wt(t,7,"rightTopToLeft")}};window.TowerGame=(t={})=>{const{width:e,height:i,canvasId:s,soundOn:a}=t,r=new u({canvasId:s,highResolution:!0,width:e,height:i,soundOn:a}),n=t=>`./assets/${t}`;r.addImg("background",n("background.png")),r.addImg("hook",n("hook.png")),r.addImg("blockRope",n("block-rope.png")),r.addImg("block",n("block.png")),r.addImg("block-perfect",n("block-perfect.png"));for(let t=1;t<=8;t+=1)r.addImg(`c${t}`,n(`c${t}.png`));r.addLayer(P);for(let t=1;t<=7;t+=1)r.addImg(`f${t}`,n(`f${t}.png`));r.swapLayer(0,1),r.addImg("tutorial",n("tutorial.png")),r.addImg("tutorial-arrow",n("tutorial-arrow.png")),r.addImg("heart",n("heart.png")),r.addImg("score",n("score.png")),r.addAudio("drop-perfect",n("drop-perfect.mp3")),r.addAudio("drop",n("drop.mp3")),r.addAudio("game-over",n("game-over.mp3")),r.addAudio("rotate",n("rotate.mp3")),r.addAudio("bgm",n("bgm.mp3")),r.setVariable(O,.25*r.width),r.setVariable(M,.71*r.getVariable(O)),r.setVariable(L,.3*r.width),r.setVariable(E,.4*r.height),r.setVariable(V,0),r.setVariable(w,0),r.setVariable(x,0),r.setVariable(f,0),r.setVariable(p,!1),r.setVariable(y,t);for(let t=1;t<=4;t+=1){const e=new m({name:`cloud_${t}`,action:nt,painter:ot});e.index=t,e.count=5-t,r.addInstance(e)}const o=new m({name:"line",action:st,painter:at});r.addInstance(o);const h=new m({name:"hook",action:ht,painter:ct});return r.addInstance(h),r.startAnimate=vt,r.endAnimate=xt,r.paintUnderInstance=it,r.addKeyDownListener("enter",(()=>{r.debug&&r.togglePaused()})),r.touchStartListener=()=>{(t=>{if(!t.getVariable(b))return;if(t.debug&&t.paused)return;if(z(t)!==T)return;t.removeInstance("tutorial"),t.removeInstance("tutorial-arrow");const e=t.getInstance(`block_${t.getVariable(V)}`);e&&e.status===R&&(t.setTimeMovement(U,500),e.status=N)})(r)},r.playBgm=()=>{r.playAudio("bgm",!0)},r.pauseBgm=()=>{r.pauseAudio("bgm")},r.start=()=>{const t=new m({name:"tutorial",action:dt,painter:lt});r.addInstance(t);const e=new m({name:"tutorial-arrow",action:dt,painter:lt});r.addInstance(e),r.setTimeMovement(G,500),r.setTimeMovement($,500),r.setVariable(b,!0)},r}})();